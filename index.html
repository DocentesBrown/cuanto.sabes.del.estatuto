<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Quiz Estatuto Docente ‚Äî Cap. XII: Del Ingreso</title>
  <style>
    :root{
      --azul:#24496e; --violeta:#4d3069; --celeste:#3d8fb0; --beige:#f3efdc; --rojo:#da6863;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--beige); color:var(--azul);
      display:flex; min-height:100vh; align-items:center; justify-content:center;
    }
    .app{
      width:92%; max-width:560px; background:#fff; border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.15); padding:18px 16px 20px;
    }
    header{ text-align:center; margin-bottom:8px;}
    header h1{ margin:0; font-size:1.35rem; color:var(--azul); }
    header p{ margin:6px 0 0; color:var(--violeta); font-weight:600; }
    .timer{ margin:10px 0 14px; font-weight:700; color:var(--rojo); text-align:center; }
    .question{ font-size:1.05rem; font-weight:700; margin:4px 0 10px; color:var(--azul);}
    .options{ display:grid; gap:8px; }
    .btn{
      width:100%; padding:12px 14px; border:0; border-radius:12px; cursor:pointer;
      font-size:1rem; color:#fff; background:var(--celeste); transition:transform .05s ease, opacity .15s ease;
    }
    .btn:hover{ opacity:.9 }
    .btn:active{ transform:scale(.995) }
    .btn.alt{ background:var(--rojo) }
    .btn.dark{ background:var(--azul) }
    .btn.violet{ background:var(--violeta) }
    .btn-row{ display:grid; gap:10px; margin-top:12px; }
    .muted{ color:#666; font-size:.95rem; text-align:center; }
    .hidden{ display:none !important; }
    .result h2{ margin:0 0 6px; color:var(--violeta); }
    .result p{ margin:6px 0; }
    .leaderboard{
      margin-top:14px; background:#fff; border:1px solid #e8e6de; border-radius:14px; overflow:hidden;
    }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      background:var(--violeta); color:#fff; padding:10px; font-weight:700; font-size:.95rem; text-align:center;
    }
    tbody td{
      border-top:1px solid #eee; padding:9px; font-size:.95rem; text-align:center; color:#1d2a38;
    }
    .pill{
      display:inline-block; padding:2px 8px; border-radius:999px; background:#eef4f8; color:#274b6d; font-size:.8rem;
    }
    .topbar{
      display:grid; gap:8px; margin:8px 0 10px;
      grid-template-columns: 1fr 1fr; /* dos por fila en m√≥vil */
    }
    @media (min-width:520px){
      .topbar{ grid-template-columns: 1fr 1fr 1fr; } /* tres por fila en desktop */
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Quiz: Estatuto Docente</h1>
      <p>Cap√≠tulo XII ‚Äî Del Ingreso</p>
    </header>

    <!-- Top buttons -->
    <div class="topbar">
      <button class="btn violet" id="btnToggleLB">üìä Ver / ocultar posiciones</button>
      <button class="btn dark" id="btnEstatuto">üìï Descargar Estatuto</button>
      <button class="btn alt" id="btnClear">üóëÔ∏è Limpiar tabla</button>
    </div>

    <!-- Game -->
    <div id="game">
      <div class="timer">‚è≥ Tiempo restante: <span id="timer">20</span>s</div>
      <div class="question" id="question"></div>
      <div class="options" id="options"></div>
      <p class="muted" id="progress"></p>
    </div>

    <!-- Result -->
    <div id="result" class="result hidden">
      <h2>¬°Juego terminado!</h2>
      <p>Puntaje obtenido: <span id="finalScore" class="pill">0</span></p>
      <p>Tiempo total usado: <span id="finalTime" class="pill">0s</span></p>
      <div class="btn-row">
        <button class="btn dark" id="btnReplay">üîÑ Volver a jugar</button>
      </div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboardWrap" class="leaderboard hidden">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Jugador</th>
            <th>Puntaje</th>
            <th>Tiempo (s)</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody">
          <tr><td colspan="5" class="muted">Cargando‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <p class="muted">Puntaje: 100 por acierto + 5 por cada segundo ahorrado.</p>
  </div>

  <script>
    // ====== CONFIG ======
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwX8whu7tz-FnGiZ0Eo9rzOJZKjxF3fQQWpaTXpV98vDG0mIDsg0Ygca_WyEiRYcSOG/exec";
    const TIEMPO_PREGUNTA = 20;

    // ====== PREGUNTAS (6) ======
    const questions = [
      {
        q: "¬øC√≥mo se realiza el ingreso a la docencia seg√∫n el Cap. XII?",
        options: [
          "Por orden de m√©rito en listados oficiales",
          "Por recomendaci√≥n de directivos",
          "Por sorteo de cargos",
          "Por votaci√≥n en la escuela"
        ],
        a: 0
      },
      {
        q: "¬øQu√© organismo confecciona y aprueba los listados de aspirantes?",
        options: [
          "Consejo Escolar",
          "Direcci√≥n General de Cultura y Educaci√≥n",
          "Sindicatos Docentes",
          "Jefatura Distrital"
        ],
        a: 1
      },
      {
        q: "Requisito b√°sico para figurar en los listados de ingreso:",
        options: [
          "Antig√ºedad docente comprobable",
          "Tener t√≠tulo habilitante",
          "Experiencia previa m√≠nima",
          "Recomendaci√≥n gremial"
        ],
        a: 1
      },
      {
        q: "Periodicidad de inscripci√≥n y actualizaci√≥n de listados:",
        options: ["Anual", "Cada 3 a√±os", "Cada 5 a√±os", "A demanda de cada escuela"],
        a: 0
      },
      {
        q: "Criterio principal para ordenar a los aspirantes:",
        options: [
          "Edad del aspirante",
          "Fecha de inscripci√≥n",
          "Puntaje del escalaf√≥n (antecedentes y t√≠tulos)",
          "Entrevista personal"
        ],
        a: 2
      },
      {
        q: "¬øC√≥mo se otorgan los cargos a los aspirantes?",
        options: [
          "En acto p√∫blico seg√∫n orden de m√©rito",
          "Por decisi√≥n del director",
          "Por concurso de antecedentes y oposici√≥n en cada escuela",
          "Por inscripci√≥n espont√°nea el d√≠a del inicio"
        ],
        a: 0
      }
    ];

    // ====== ESTADO DE JUEGO ======
    let current = 0;
    let score = 0;
    let timer = null;
    let timeLeft = TIEMPO_PREGUNTA;
    let totalTimeUsed = 0;
    let playerName = null;

    // ====== NODOS ======
    const elTimer = document.getElementById("timer");
    const elQuestion = document.getElementById("question");
    const elOptions = document.getElementById("options");
    const elProgress = document.getElementById("progress");
    const elGame = document.getElementById("game");
    const elResult = document.getElementById("result");
    const elFinalScore = document.getElementById("finalScore");
    const elFinalTime = document.getElementById("finalTime");
    const elLBWrap = document.getElementById("leaderboardWrap");
    const elLBTbody = document.getElementById("leaderboardBody");

    // ====== INICIO ======
    startQuiz();

    function startQuiz(){
      score = 0;
      current = 0;
      totalTimeUsed = 0;
      playerName = prompt("Ingres√° tu nombre para jugar:") || "An√≥nimo";
      elResult.classList.add("hidden");
      elGame.classList.remove("hidden");
      renderQuestion();
      startTimer();
    }

    function renderQuestion(){
      const q = questions[current];
      elQuestion.textContent = q.q;
      elOptions.innerHTML = "";
      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = opt;
        btn.onclick = () => selectAnswer(i, btn);
        elOptions.appendChild(btn);
      });
      timeLeft = TIEMPO_PREGUNTA;
      elTimer.textContent = timeLeft;
      elProgress.textContent = `Pregunta ${current+1} de ${questions.length}`;
    }

    function startTimer(){
      clearInterval(timer);
      timer = setInterval(() => {
        timeLeft--;
        elTimer.textContent = timeLeft;
        if(timeLeft <= 0){
          clearInterval(timer);
          totalTimeUsed += TIEMPO_PREGUNTA; // agot√≥ el tiempo
          nextQuestion();
        }
      }, 1000);
    }

    function selectAnswer(idx, btn){
      // desactivar para evitar doble click
      [...elOptions.children].forEach(b => b.disabled = true);

      clearInterval(timer);
      const q = questions[current];
      const used = TIEMPO_PREGUNTA - timeLeft;
      totalTimeUsed += used;

      if(idx === q.a){
        score += 100 + (timeLeft * 5);
      }
      // breve delay para feedback visual si quisieras
      setTimeout(nextQuestion, 200);
    }

    function nextQuestion(){
      current++;
      if(current < questions.length){
        renderQuestion();
        startTimer();
      } else {
        endQuiz();
      }
    }

    async function endQuiz(){
      elGame.classList.add("hidden");
      elResult.classList.remove("hidden");
      elFinalScore.textContent = score;
      elFinalTime.textContent = `${totalTimeUsed}s`;

      // Guardar en tabla global
      try{
        await fetch(`${SCRIPT_URL}?action=add&nombre=${encodeURIComponent(playerName)}&puntaje=${encodeURIComponent(score)}&tiempo=${encodeURIComponent(totalTimeUsed)}`);
      }catch(e){
        console.error(e);
        alert("‚ö†Ô∏è No se pudo guardar el puntaje en la tabla global. Prob√° de nuevo m√°s tarde.");
      }

      // refrescar leaderboard si est√° visible
      if(!elLBWrap.classList.contains("hidden")){
        await loadLeaderboard();
      }
    }

    // ====== LEADERBOARD GLOBAL (Apps Script) ======
    async function loadLeaderboard(){
      elLBTbody.innerHTML = `<tr><td colspan="5" class="muted">Cargando‚Ä¶</td></tr>`;
      try{
        const res = await fetch(`${SCRIPT_URL}?action=get`);
        const rows = await res.json(); // se espera array de arrays
        // Primera fila: encabezados. Luego: [Nombre, Puntaje, Tiempo, Fecha]
        const data = (rows || []).slice(1).filter(r => r && r.length);
        // Ordenar por puntaje desc, y a igualdad por tiempo asc
        data.sort((a,b) => (Number(b[1]||0) - Number(a[1]||0)) || (Number(a[2]||0) - Number(b[2]||0)));

        if(data.length === 0){
          elLBTbody.innerHTML = `<tr><td colspan="5" class="muted">No hay registros a√∫n.</td></tr>`;
          return;
        }

        elLBTbody.innerHTML = "";
        data.forEach((r, i) => {
          const tr = document.createElement("tr");
          const fecha = r[3] ? formatDate(r[3]) : "-";
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${escapeHtml(r[0] ?? "‚Äî")}</td>
            <td>${Number(r[1]||0)}</td>
            <td>${Number(r[2]||0)}</td>
            <td>${fecha}</td>
          `;
          elLBTbody.appendChild(tr);
        });
      }catch(e){
        console.error(e);
        elLBTbody.innerHTML = `<tr><td colspan="5" class="muted">Error al cargar la tabla.</td></tr>`;
      }
    }

    function formatDate(v){
      // Apps Script suele devolver fecha como string; mostramos tal cual o intentamos formatear simple.
      const d = new Date(v);
      if(!isNaN(d.getTime())){
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
      }
      return String(v);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    // ====== BOTONES SUPERIORES ======
    document.getElementById("btnToggleLB").addEventListener("click", async () => {
      elLBWrap.classList.toggle("hidden");
      if(!elLBWrap.classList.contains("hidden")){
        await loadLeaderboard();
      }
    });

    document.getElementById("btnEstatuto").addEventListener("click", () => {
      window.open("https://drive.google.com/file/d/1ct0y2Phs9b45tcL2kLm8Cl6fA6dw8Y_F/view?usp=sharing", "_blank", "noopener");
    });

    document.getElementById("btnClear").addEventListener("click", async () => {
      const clave = prompt("Ingrese la clave para limpiar la tabla:");
      if(!clave) return;
      try{
        const res = await fetch(`${SCRIPT_URL}?action=clear&clave=${encodeURIComponent(clave)}`);
        const text = await res.text();
        alert(text);
        if(!elLBWrap.classList.contains("hidden")){
          await loadLeaderboard();
        }
      }catch(e){
        console.error(e);
        alert("Error al limpiar la tabla.");
      }
    });

    document.getElementById("btnReplay").addEventListener("click", () => {
      startQuiz();
    });
  </script>
</body>
</html>
